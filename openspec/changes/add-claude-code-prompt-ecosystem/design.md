# æŠ€æœ¯è®¾è®¡æ–‡æ¡£ï¼šClaude Code æç¤ºè¯ç”Ÿæ€ç³»ç»Ÿ

## Contextï¼ˆèƒŒæ™¯ï¼‰

### é—®é¢˜åŸŸ
è‹¥çˆ±ï¼ˆIfAIï¼‰éœ€è¦ä»å•ä¸€ AI æ™ºèƒ½ä½“æ¼”è¿›åˆ°å¤šæ™ºèƒ½ä½“ç”Ÿæ€ç³»ç»Ÿï¼Œå€Ÿé‰´ Claude Code çš„æˆç†Ÿæ¶æ„ï¼Œå®ç°ï¼š
1. é€æ˜å¯æ§çš„æç¤ºè¯ç®¡ç†
2. ä¸“ä¸šåŒ–æ™ºèƒ½ä½“åä½œ
3. æ ‡å‡†åŒ–å·¥å…·ç³»ç»Ÿ
4. é«˜æ•ˆå¯¹è¯ç®¡ç†

### æŠ€æœ¯çº¦æŸ
- **å‰ç«¯**: React 19 + TypeScript 5.8 + Zustand + TailwindCSS
- **åç«¯**: Rust + Tauri 2.0 + tokio å¼‚æ­¥è¿è¡Œæ—¶
- **AI æ ¸å¿ƒ**: ç§æœ‰ ifainew-core åŒ…ï¼ˆéœ€æ‰©å±•æ¥å£ï¼‰
- **æ€§èƒ½è¦æ±‚**:
  - æ™ºèƒ½ä½“å¯åŠ¨ < 2s
  - å·¥å…·æ‰§è¡Œ < 500ms
  - UI å“åº” < 100ms
- **å…¼å®¹æ€§**: éœ€å‘åå…¼å®¹ç°æœ‰ AI å¯¹è¯æ•°æ®

### åˆ©ç›Šç›¸å…³æ–¹
- **æœ€ç»ˆç”¨æˆ·**: å¼€å‘è€…ï¼Œéœ€è¦é«˜æ•ˆã€é€æ˜ã€å¯æ§çš„ AI ç¼–ç åŠ©æ‰‹
- **å¼€å‘å›¢é˜Ÿ**: éœ€è¦æ¸…æ™°çš„æ¶æ„ã€æ˜“ç»´æŠ¤çš„ä»£ç 
- **ç¤¾åŒºè´¡çŒ®è€…**: éœ€è¦å¯æ‰©å±•çš„æ’ä»¶ç³»ç»Ÿ

## Goals / Non-Goalsï¼ˆç›®æ ‡ä¸éç›®æ ‡ï¼‰

### Goalsï¼ˆç›®æ ‡ï¼‰
1. âœ… **é€æ˜åŒ–**: ç”¨æˆ·å¯æŸ¥çœ‹ã€ç¼–è¾‘ã€ç‰ˆæœ¬åŒ–ç®¡ç†ç³»ç»Ÿæç¤ºè¯
2. âœ… **ä¸“ä¸šåŒ–**: æä¾›è‡³å°‘ 5 ç§ä¸“ä¸šæ™ºèƒ½ä½“ï¼ˆExploreã€Reviewã€Testã€Docã€Refactorï¼‰
3. âœ… **æ ‡å‡†åŒ–**: å®šä¹‰ç»Ÿä¸€çš„å·¥å…·æ¥å£å’Œæè¿°æ ¼å¼
4. âœ… **é«˜æ•ˆåŒ–**: æ™ºèƒ½ä½“å¹¶è¡Œæ‰§è¡Œï¼Œå¯¹è¯è‡ªåŠ¨æ€»ç»“ï¼Œä¸Šä¸‹æ–‡ç®¡ç†
5. âœ… **å¯æ‰©å±•**: æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ™ºèƒ½ä½“å’Œå·¥å…·ï¼ˆTypeScript/Rust æ’ä»¶ï¼‰
6. âœ… **å¹³æ»‘è¿ç§»**: è‡ªåŠ¨è¿ç§»ç°æœ‰å¯¹è¯æ•°æ®ï¼Œä¿æŒå‘åå…¼å®¹

### Non-Goalsï¼ˆéç›®æ ‡ï¼‰
1. âŒ **ä¸æ”¯æŒäº‘ç«¯åŒæ­¥**: æœ¬æœŸä¸å®ç°æç¤ºè¯äº‘ç«¯å­˜å‚¨å’ŒåŒæ­¥ï¼ˆç•™å¾…æœªæ¥ï¼‰
2. âŒ **ä¸æ”¯æŒæ™ºèƒ½ä½“å¸‚åœº**: æœ¬æœŸä¸åšæ™ºèƒ½ä½“åˆ†äº«å’Œä¸‹è½½å¹³å°ï¼ˆç•™å¾…æœªæ¥ï¼‰
3. âŒ **ä¸é‡å†™ ifainew-core**: åªæ‰©å±•æ¥å£ï¼Œä¸é‡æ„æ ¸å¿ƒ AI å¼•æ“
4. âŒ **ä¸æ”¯æŒæ‰€æœ‰ç¼–ç¨‹è¯­è¨€**: å·¥å…·ç³»ç»Ÿå…ˆæ”¯æŒå¸¸è§è¯­è¨€ï¼ˆJS/TSã€Rustã€Pythonï¼‰ï¼Œå…¶ä»–è¯­è¨€é€æ­¥æ·»åŠ 

## Decisionsï¼ˆæŠ€æœ¯å†³ç­–ï¼‰

### å†³ç­– 1: æç¤ºè¯å­˜å‚¨æ ¼å¼

**é€‰æ‹©**: Markdown æ–‡ä»¶ + YAML Front Matter

**åŸå› **:
- ä¸ claude-code-system-prompts ä¿æŒä¸€è‡´ï¼Œæ˜“äºè¿ç§»
- Markdown å¯è¯»æ€§å¼ºï¼Œæ”¯æŒä»£ç é«˜äº®å’Œæ ¼å¼åŒ–
- YAML Front Matter å­˜å‚¨å…ƒæ•°æ®ï¼ˆå˜é‡ã€ç‰ˆæœ¬ã€æè¿°ç­‰ï¼‰
- Git å‹å¥½ï¼Œæ˜“äºç‰ˆæœ¬æ§åˆ¶å’Œ diff

**æ›¿ä»£æ–¹æ¡ˆåŠæ‹’ç»ç†ç”±**:
- **JSON/YAML**: ä¸å¦‚ Markdown å¯è¯»ï¼Œä¸æ”¯æŒå¤šè¡Œæ–‡æœ¬æ ¼å¼åŒ–
- **æ•°æ®åº“**: è¿‡é‡ï¼Œä¸åˆ©äºç‰ˆæœ¬æ§åˆ¶å’Œç”¨æˆ·ç¼–è¾‘
- **çº¯æ–‡æœ¬**: ç¼ºä¹ç»“æ„åŒ–å…ƒæ•°æ®

**ç¤ºä¾‹æ ¼å¼**:
```markdown
---
name: "System Prompt: Code Review"
description: "ä¸“ä¸šä»£ç å®¡æŸ¥æ™ºèƒ½ä½“æç¤ºè¯"
version: "1.0.0"
variables:
  - LANGUAGE
  - FRAMEWORK
  - SEVERITY_LEVEL
---

You are a professional code reviewer specializing in ${LANGUAGE} and ${FRAMEWORK}.
Focus on identifying issues with severity level: ${SEVERITY_LEVEL}.

Your tasks:
1. Analyze code for bugs, security issues, and best practice violations
2. Suggest improvements with clear explanations
3. Provide actionable recommendations

...
```

### å†³ç­– 2: æç¤ºè¯åˆ†å±‚å…¬å¼€ç­–ç•¥

**é€‰æ‹©**: ä¸‰å±‚è®¿é—®æ§åˆ¶æ¶æ„ï¼ˆå…¬å¼€å±‚ã€åŠé€æ˜å±‚ã€éšè—å±‚ï¼‰

**åŸå› **:
- å¹³è¡¡é€æ˜åº¦å’Œå•†ä¸šä¿æŠ¤ï¼šå¤§éƒ¨åˆ†æç¤ºè¯å¼€æ”¾ï¼ˆå»ºç«‹ä¿¡ä»»ï¼‰ï¼Œæ ¸å¿ƒç®—æ³•ä¿æŠ¤ï¼ˆå•†ä¸šä»·å€¼ï¼‰
- åŸ¹å…»ç¤¾åŒºç”Ÿæ€ï¼šç”¨æˆ·å¯åˆ†äº«è‡ªå®šä¹‰æ™ºèƒ½ä½“å’Œå·¥å…·
- å®‰å…¨è€ƒè™‘ï¼šåæ»¥ç”¨è§„åˆ™ä¸å…¬å¼€ï¼Œé˜²æ­¢æ¶æ„åˆ©ç”¨
- ç”¨æˆ·ä½“éªŒï¼šé«˜çº§ç”¨æˆ·å¯æ·±åº¦å®šåˆ¶ï¼ˆä¸“å®¶æ¨¡å¼ï¼‰

**ä¸‰å±‚æ¶æ„å®šä¹‰**:

#### ğŸŸ¢ å…¬å¼€å±‚ï¼ˆPublic Tierï¼‰
**èŒƒå›´**: çº¦ 80% çš„æç¤ºè¯

**åŒ…å«å†…å®¹**:
- ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯ï¼ˆ`.ifai/prompts/custom/`ï¼‰
- å®˜æ–¹æ™ºèƒ½ä½“æ¨¡æ¿ï¼ˆ`.ifai/prompts/agents/`ï¼‰
- å·¥å…·æè¿°æç¤ºè¯ï¼ˆ`.ifai/prompts/tools/`ï¼‰
- ç¤ºä¾‹å’Œæ•™ç¨‹æç¤ºè¯ï¼ˆ`.ifai/prompts/examples/`ï¼‰

**è®¿é—®æ§åˆ¶**:
```rust
pub struct PromptAccessControl {
    pub tier: AccessTier::Public,
    pub can_view: true,
    pub can_edit: true,
    pub can_export: true,
    pub can_version: true,
    pub can_share: true,
}
```

**UI å±•ç¤º**:
```typescript
<PromptEditor
  prompt={publicPrompt}
  editable={true}
  showSource={true}
  badge="å¯ç¼–è¾‘"
  badgeColor="green"
/>
```

#### ğŸŸ¡ åŠé€æ˜å±‚ï¼ˆProtected Tierï¼‰
**èŒƒå›´**: çº¦ 15% çš„æç¤ºè¯

**åŒ…å«å†…å®¹**:
- ç³»ç»Ÿä¸»æç¤ºè¯ï¼ˆ`.ifai/prompts/system/main.md`ï¼‰
- å®‰å…¨å’Œæƒé™è§„åˆ™ï¼ˆ`.ifai/prompts/system/security.md`ï¼‰
- å¯¹è¯ç®¡ç†æç¤ºè¯ï¼ˆ`.ifai/prompts/system/conversation.md`ï¼‰

**è®¿é—®æ§åˆ¶**:
```rust
pub struct PromptAccessControl {
    pub tier: AccessTier::Protected,
    pub can_view: true,
    pub can_edit: false,          // é»˜è®¤ä¸å¯ç¼–è¾‘
    pub can_export: true,
    pub can_version: false,
    pub can_override: true,       // ä¸“å®¶æ¨¡å¼å¯è¦†ç›–
}
```

**è¦†ç›–æœºåˆ¶**:
```rust
// ç”¨æˆ·å¯ä»¥åˆ›å»ºè¦†ç›–æ–‡ä»¶
// ç›®å½•ç»“æ„ï¼š
// .ifai/prompts/system/main.md              (å®˜æ–¹ï¼Œåªè¯»)
// .ifai/prompts/system/main.override.md     (ç”¨æˆ·è¦†ç›–ï¼Œå¯ç¼–è¾‘)

pub fn load_system_prompt(config: &Config) -> Result<String> {
    let official_path = ".ifai/prompts/system/main.md";
    let override_path = ".ifai/prompts/system/main.override.md";

    if config.expert_mode && Path::new(override_path).exists() {
        log::warn!("âš ï¸ ä½¿ç”¨ç”¨æˆ·è¦†ç›–çš„ç³»ç»Ÿæç¤ºè¯");
        read_prompt(override_path)
    } else {
        read_prompt(official_path)
    }
}
```

**UI å±•ç¤º**:
```typescript
<PromptViewer
  prompt={protectedPrompt}
  editable={false}
  showSource={true}
  badge="åªè¯»"
  badgeColor="yellow"
  showWarning={true}
  warningText="è¿™æ˜¯ç³»ç»Ÿæ ¸å¿ƒæç¤ºè¯ï¼Œä¿®æ”¹å¯èƒ½å¯¼è‡´ä¸ç¨³å®š"
  allowOverride={settings.expertMode}
  onCreateOverride={() => {
    // åˆ›å»ºç”¨æˆ·è¦†ç›–ç‰ˆæœ¬
    createOverridePrompt(protectedPrompt);
  }}
/>
```

#### ğŸ”´ éšè—å±‚ï¼ˆPrivate Tierï¼‰
**èŒƒå›´**: çº¦ 5% çš„æç¤ºè¯

**åŒ…å«å†…å®¹**:
- ifainew-core å†…éƒ¨æç¤ºè¯ï¼ˆä¸åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼ŒåµŒå…¥ä»£ç ï¼‰
- ä¸“æœ‰ç®—æ³•å’Œä¼˜åŒ–æŠ€å·§
- åæ»¥ç”¨è§„åˆ™ï¼ˆæç¤ºè¯æ³¨å…¥æ£€æµ‹ï¼‰

**è®¿é—®æ§åˆ¶**:
```rust
pub struct PromptAccessControl {
    pub tier: AccessTier::Private,
    pub can_view: false,
    pub can_edit: false,
    pub can_export: false,
    pub can_version: false,
    pub can_override: false,
}
```

**å®ç°æ–¹å¼**:
```rust
// ifainew-core å†…éƒ¨ï¼ˆRust åç«¯ï¼Œå‰ç«¯å®Œå…¨ä¸å¯è§ï¼‰
pub(crate) fn build_complete_prompt(
    user_prompt: &str,
    context: &Context,
) -> String {
    // æ ¸å¿ƒæç¤ºè¯åµŒå…¥åœ¨ä»£ç ä¸­ï¼Œä¸ä½œä¸ºæ–‡ä»¶å­˜å‚¨
    let core_secret = include_str!("../prompts/core_secret.md");
    let anti_abuse_rules = generate_anti_abuse_rules(context);

    // ç»„åˆï¼šéšè— + åŠé€æ˜ + å…¬å¼€
    format!(
        "{}\n\n{}\n\n{}\n\n{}",
        core_secret,           // ğŸ”´ éšè—å±‚
        anti_abuse_rules,      // ğŸ”´ éšè—å±‚
        load_system_prompt(),  // ğŸŸ¡ åŠé€æ˜å±‚
        user_prompt,           // ğŸŸ¢ å…¬å¼€å±‚
    )
}
```

**UI å±•ç¤º**:
```typescript
// åœ¨å¯¹è¯ä¸­æ˜¾ç¤ºæç¤ºè¯ç»„æˆï¼ˆä¸æ˜¾ç¤ºéšè—å†…å®¹ï¼‰
<PromptComposition>
  <PromptSection
    type="private"
    icon="ğŸ”’"
    label="æ ¸å¿ƒæç¤ºè¯ï¼ˆifainew-core ç®¡ç†ï¼‰"
    viewable={false}
  />
  <PromptSection
    type="protected"
    icon="ğŸ‘ï¸"
    label="ç³»ç»Ÿä¸»æç¤ºè¯"
    viewable={true}
    content={systemPrompt}
  />
  <PromptSection
    type="public"
    icon="âœï¸"
    label="Review Agent æç¤ºè¯"
    viewable={true}
    editable={true}
    content={agentPrompt}
  />
</PromptComposition>
```

**å®‰å…¨é˜²æŠ¤**:
```rust
// é˜²æ­¢æç¤ºè¯æ³¨å…¥æ”»å‡»
pub fn validate_user_prompt(prompt: &str) -> Result<(), ValidationError> {
    let dangerous_patterns = vec![
        r"ignore\s+previous\s+instructions",
        r"forget\s+everything",
        r"you\s+are\s+now",
        r"system\s*:\s*",
        // ... æ›´å¤šæ”»å‡»æ¨¡å¼
    ];

    for pattern in dangerous_patterns {
        let re = Regex::new(pattern)?;
        if re.is_match(prompt) {
            return Err(ValidationError::PotentialInjection {
                pattern: pattern.to_string(),
                suggestion: "æç¤ºè¯åŒ…å«æ½œåœ¨çš„æ³¨å…¥æ”»å‡»æ¨¡å¼ï¼Œè¯·ä¿®æ”¹".to_string(),
            });
        }
    }

    Ok(())
}
```

**æ›¿ä»£æ–¹æ¡ˆåŠæ‹’ç»ç†ç”±**:
- **å®Œå…¨å…¬å¼€**ï¼ˆå¦‚ Claude Codeï¼‰: é€‚åˆå¼€æºå·¥å…·ï¼Œä½† ifainew-core æ˜¯å•†ä¸šäº§å“ï¼Œéœ€ä¿æŠ¤æ ¸å¿ƒç«äº‰åŠ›
- **å®Œå…¨éšè—**ï¼ˆå¦‚ä¼ ç»Ÿ SaaSï¼‰: ç”¨æˆ·ä¸ä¿¡ä»»ï¼Œæ— æ³•æ·±åº¦å®šåˆ¶ï¼Œè¿èƒŒ"é€æ˜åŒ–"ç›®æ ‡
- **åªè¯»å…¬å¼€**ï¼ˆä¸¤å±‚ï¼‰: ç¼ºä¹çµæ´»æ€§ï¼Œé«˜çº§ç”¨æˆ·æ— æ³•å®šåˆ¶ç³»ç»Ÿè¡Œä¸º

**å¯¹æ¯” Claude Code**:

| ç»´åº¦ | Claude Code | IfAIï¼ˆæœ¬æ–¹æ¡ˆï¼‰ |
|------|-------------|----------------|
| å®šä½ | å¼€æº CLI å·¥å…· | å•†ä¸šåŒ– AI ç¼–è¾‘å™¨ |
| æ ¸å¿ƒæç¤ºè¯å…¬å¼€æ€§ | 100% å¼€æº | 80% å…¬å¼€ + 15% å¯è§ + 5% éšè— |
| ç”¨æˆ·å®šåˆ¶èƒ½åŠ› | æé«˜ï¼ˆå®Œå…¨å¼€æ”¾ï¼‰ | é«˜ï¼ˆå…¬å¼€å±‚å®Œå…¨å¼€æ”¾ï¼‰ |
| å•†ä¸šä¿æŠ¤ | æ—  | ä¸­ï¼ˆæ ¸å¿ƒç®—æ³•éšè—ï¼‰ |
| é€æ˜åº¦ | æé«˜ | é«˜ï¼ˆ95% å¯è§ï¼‰ |
| ç¤¾åŒºç”Ÿæ€æ½œåŠ› | æå¼º | å¼ºï¼ˆå…¬å¼€å±‚å¯åˆ†äº«ï¼‰ |

**å†³ç­–æ€»ç»“**:
é‡‡ç”¨åˆ†å±‚å…¬å¼€ç­–ç•¥ï¼Œæ—¢äº«å—é€æ˜åº¦å¸¦æ¥çš„ä¿¡ä»»å’Œç¤¾åŒºç”Ÿæ€ä¼˜åŠ¿ï¼Œåˆä¿æŠ¤æ ¸å¿ƒå•†ä¸šä»·å€¼ã€‚è¿™æ˜¯ IfAI ä½œä¸ºå•†ä¸šåŒ–äº§å“çš„æœ€ä¼˜å¹³è¡¡ç‚¹ã€‚

---

### å†³ç­– 3: æ™ºèƒ½ä½“æ¶æ„è®¾è®¡

**é€‰æ‹©**: Actor æ¨¡å‹ + å¼‚æ­¥æ¶ˆæ¯ä¼ é€’

**åŸå› **:
- Rust çš„ tokio ç”Ÿæ€å¯¹ Actor æ¨¡å¼æ”¯æŒè‰¯å¥½ï¼ˆä½¿ç”¨ `tokio::task`ï¼‰
- æ™ºèƒ½ä½“ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸é˜»å¡ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡Œ
- æ¶ˆæ¯ä¼ é€’è§£è€¦æ™ºèƒ½ä½“é—´é€šä¿¡ï¼Œæ˜“äºæ‰©å±•
- ä¾¿äºå®ç°æ™ºèƒ½ä½“çš„å¯åŠ¨ã€åœæ­¢ã€æ¢å¤ã€ç›‘æ§

**æ¶æ„å›¾**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend (React)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AgentPanel   â”‚  â”‚ AIChat Component        â”‚ â”‚
â”‚  â”‚ (UI Control) â”‚  â”‚ (Message Display)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                  â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ Tauri Events     â”‚ Tauri Commands
          â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend (Rust)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Agent System (Actor Model)              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Supervisor â”‚  â”‚ Message Router      â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚        â”‚                â”‚                 â”‚  â”‚
â”‚  â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚        â–¼         â–¼         â–¼         â–¼   â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚   â”‚Explore â”‚ â”‚Reviewâ”‚ â”‚Test  â”‚ â”‚Doc   â”‚ â”‚  â”‚
â”‚  â”‚   â”‚Agent   â”‚ â”‚Agent â”‚ â”‚Agent â”‚ â”‚Agent â”‚ â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚        â”‚         â”‚        â”‚        â”‚     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚         â”‚        â”‚        â”‚        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”‚
â”‚     â”‚      Tool Registry & Executor          â”‚ â”‚
â”‚     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                            â”‚       â”‚
â”‚       â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”‚
â”‚       â”‚ Read   â”‚  â”‚ Write  â”‚  â”‚ Bash       â”‚  â”‚
â”‚       â”‚ Tool   â”‚  â”‚ Tool   â”‚  â”‚ Tool       â”‚  â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ifainew-core â”‚
              â”‚ (AI Models)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç»„ä»¶**:
1. **Supervisor**: ç®¡ç†æ™ºèƒ½ä½“ç”Ÿå‘½å‘¨æœŸï¼ˆå¯åŠ¨ã€åœæ­¢ã€é‡å¯ï¼‰
2. **Message Router**: è·¯ç”±æ¶ˆæ¯åˆ°æ­£ç¡®çš„æ™ºèƒ½ä½“
3. **Agent**: ç‹¬ç«‹çš„ tokio taskï¼Œå¤„ç†ç‰¹å®šä»»åŠ¡
4. **Tool Registry**: å·¥å…·æ³¨å†Œè¡¨ï¼Œç®¡ç†å¯ç”¨å·¥å…·
5. **Tool Executor**: æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼Œå¤„ç†æƒé™å’Œæ²™ç®±

**æ›¿ä»£æ–¹æ¡ˆåŠæ‹’ç»ç†ç”±**:
- **å¤šçº¿ç¨‹å…±äº«çŠ¶æ€**: å¤æ‚ï¼Œæ˜“å‡ºç°ç«æ€æ¡ä»¶ï¼ŒRust æ‰€æœ‰æƒéš¾å¤„ç†
- **å•çº¿ç¨‹äº‹ä»¶å¾ªç¯**: æ— æ³•åˆ©ç”¨å¤šæ ¸ï¼Œæ€§èƒ½å—é™
- **è¿›ç¨‹çº§éš”ç¦»**: è¿‡é‡ï¼Œå¯åŠ¨æ…¢ï¼ŒIPC å¤æ‚

### å†³ç­– 3: å·¥å…·ç³»ç»Ÿæ¥å£è®¾è®¡

**é€‰æ‹©**: ç±» JSON-RPC çš„å·¥å…·è°ƒç”¨åè®®

**åŸå› **:
- ä¸ OpenAI function calling æ ¼å¼å¯¹é½ï¼Œæ˜“äºä¸ AI æ¨¡å‹é›†æˆ
- ç»“æ„åŒ–å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†
- æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å·¥å…·
- æ˜“äºåºåˆ—åŒ–å’Œæ—¥å¿—è®°å½•

**æ¥å£å®šä¹‰** (Rust):
```rust
/// å·¥å…·æè¿°
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ToolDescriptor {
    pub name: String,
    pub description: String,
    pub parameters: ToolParameters,
    pub examples: Vec<ToolExample>,
    pub constraints: Vec<String>,
}

/// å·¥å…·å‚æ•°æ¨¡å¼ï¼ˆJSON Schemaï¼‰
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ToolParameters {
    #[serde(rename = "type")]
    pub type_: String, // "object"
    pub properties: HashMap<String, ParameterProperty>,
    pub required: Vec<String>,
}

/// å·¥å…·è°ƒç”¨è¯·æ±‚
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ToolCall {
    pub id: String,
    pub tool_name: String,
    pub arguments: serde_json::Value,
}

/// å·¥å…·è°ƒç”¨ç»“æœ
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ToolResult {
    pub call_id: String,
    pub status: ToolStatus,
    pub output: Option<String>,
    pub error: Option<String>,
    pub metadata: HashMap<String, serde_json::Value>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum ToolStatus {
    Success,
    Error,
    Timeout,
    Blocked, // è¢«æƒé™æˆ–æ²™ç®±é˜»æ­¢
}

/// å·¥å…· trait
#[async_trait]
pub trait Tool: Send + Sync {
    fn descriptor(&self) -> &ToolDescriptor;
    async fn execute(&self, args: serde_json::Value) -> Result<ToolResult, ToolError>;
}
```

**å·¥å…·æ³¨å†Œç¤ºä¾‹**:
```rust
// æ³¨å†Œå†…ç½®å·¥å…·
tool_registry.register(Box::new(ReadTool::new()));
tool_registry.register(Box::new(WriteTool::new()));
tool_registry.register(Box::new(BashTool::new()));

// æ³¨å†Œç”¨æˆ·è‡ªå®šä¹‰å·¥å…·ï¼ˆé€šè¿‡æ’ä»¶ï¼‰
let custom_tool = load_custom_tool("path/to/plugin.wasm")?;
tool_registry.register(custom_tool);
```

### å†³ç­– 4: å¯¹è¯æ€»ç»“ç­–ç•¥

**é€‰æ‹©**: åŸºäº token é˜ˆå€¼ + ç»“æ„åŒ–æ¨¡æ¿

**åŸå› **:
- Token é˜ˆå€¼ç¡®ä¿ä¸è¶…è¿‡æ¨¡å‹ä¸Šä¸‹æ–‡é™åˆ¶ï¼ˆå¦‚ Claude 200k tokensï¼‰
- ç»“æ„åŒ–æ¨¡æ¿ä¿è¯æ€»ç»“çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- å¤ç”¨ claude-code-system-prompts çš„æ€»ç»“æç¤ºè¯ï¼Œç»è¿‡å®æˆ˜éªŒè¯

**æ€»ç»“è§¦å‘æ¡ä»¶**:
- å¯¹è¯ token æ•° > 150,000
- æ¶ˆæ¯æ•°é‡ > 100 æ¡
- ç”¨æˆ·æ‰‹åŠ¨è§¦å‘

**æ€»ç»“æ¨¡æ¿** (é‡‡ç”¨ claude-code çš„æ ¼å¼):
```markdown
## å¯¹è¯æ€»ç»“

### 1. ä¸»è¦è¯·æ±‚å’Œæ„å›¾
[ç”¨æˆ·çš„æ ¸å¿ƒéœ€æ±‚]

### 2. å…³é”®æŠ€æœ¯æ¦‚å¿µ
- [æ¦‚å¿µ 1]
- [æ¦‚å¿µ 2]

### 3. æ–‡ä»¶å’Œä»£ç å˜æ›´
- `src/components/Editor.tsx`
  - æ·»åŠ äº†è¯­æ³•é«˜äº®åŠŸèƒ½
  - ä»£ç ç‰‡æ®µ: [...]
- `src-tauri/src/file_walker.rs`
  - ä¿®å¤äº†æ–‡ä»¶éå† bug

### 4. é”™è¯¯å’Œä¿®å¤
- [é”™è¯¯æè¿°] â†’ [ä¿®å¤æ–¹æ¡ˆ]

### 5. é—®é¢˜è§£å†³
[å·²è§£å†³çš„é—®é¢˜å’Œæ­£åœ¨è¿›è¡Œçš„æ•…éšœæ’æŸ¥]

### 6. æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯
- [æ¶ˆæ¯ 1]
- [æ¶ˆæ¯ 2]

### 7. å¾…åŠä»»åŠ¡
- [ ] ä»»åŠ¡ 1
- [ ] ä»»åŠ¡ 2

### 8. å½“å‰å·¥ä½œ
[æœ€è¿‘æ­£åœ¨å¤„ç†çš„å†…å®¹]

### 9. ä¸‹ä¸€æ­¥
[å»ºè®®çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨]
```

**æ€»ç»“åçš„å¤„ç†**:
1. å­˜å‚¨å®Œæ•´å¯¹è¯åˆ° `.ifai/sessions/archive/[session_id].json`
2. å°†æ€»ç»“æ³¨å…¥ä¸ºç³»ç»Ÿæ¶ˆæ¯
3. æ¸…ç©ºæ—§æ¶ˆæ¯ï¼Œä¿ç•™æœ€è¿‘ 10 æ¡
4. ç”¨æˆ·å¯éšæ—¶æŸ¥çœ‹å®Œæ•´å†å²

### å†³ç­– 5: æç¤ºè¯å˜é‡ç³»ç»Ÿ

**é€‰æ‹©**: Handlebars æ¨¡æ¿è¯­æ³•

**åŸå› **:
- æˆç†Ÿçš„æ¨¡æ¿å¼•æ“ï¼Œæ”¯æŒå˜é‡ã€æ¡ä»¶ã€å¾ªç¯
- Rust æœ‰ `handlebars` crateï¼Œæ€§èƒ½è‰¯å¥½
- è¯­æ³•æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç¼–è¾‘
- æ”¯æŒè‡ªå®šä¹‰ helper å‡½æ•°

**ç¤ºä¾‹**:
```markdown
---
name: "Code Review Prompt"
variables:
  - LANGUAGE
  - FRAMEWORK
  - SEVERITY_LEVEL
  - FILE_PATHS
---

You are reviewing {{LANGUAGE}} code using {{FRAMEWORK}}.

Files to review:
{{#each FILE_PATHS}}
- {{this}}
{{/each}}

Focus on {{SEVERITY_LEVEL}} level issues:
{{#if (eq SEVERITY_LEVEL "critical")}}
- Security vulnerabilities
- Data corruption risks
- System crashes
{{else if (eq SEVERITY_LEVEL "warning")}}
- Best practice violations
- Performance issues
- Code smells
{{else}}
- Style and formatting
- Documentation
{{/if}}
```

**å˜é‡æ¥æº**:
1. **ç³»ç»Ÿå˜é‡**: `{{CWD}}`, `{{USER_NAME}}`, `{{PROJECT_NAME}}`
2. **ç”¨æˆ·é…ç½®**: ç”¨æˆ·åœ¨ `.ifai/config.toml` ä¸­å®šä¹‰
3. **è¿è¡Œæ—¶ä¼ é€’**: æ™ºèƒ½ä½“å¯åŠ¨æ—¶ä¼ å…¥
4. **ä¸Šä¸‹æ–‡æå–**: ä»å½“å‰æ–‡ä»¶ã€é¡¹ç›®è‡ªåŠ¨æå–ï¼ˆå¦‚ `{{CURRENT_LANGUAGE}}`ï¼‰

### å†³ç­– 6: å‰åç«¯é€šä¿¡åè®®

**é€‰æ‹©**: Tauri Commands (åŒæ­¥) + Tauri Events (å¼‚æ­¥æµå¼)

**åŸå› **:
- Tauri 2.0 åŸç”Ÿæ”¯æŒï¼Œæ— éœ€é¢å¤–ä¾èµ–
- Commands é€‚åˆè¯·æ±‚-å“åº”æ¨¡å¼ï¼ˆå¦‚å¯åŠ¨æ™ºèƒ½ä½“ï¼‰
- Events é€‚åˆæœåŠ¡å™¨æ¨é€æ¨¡å¼ï¼ˆå¦‚æ™ºèƒ½ä½“çŠ¶æ€æ›´æ–°ã€æµå¼è¾“å‡ºï¼‰
- ç±»å‹å®‰å…¨ï¼ŒRust å’Œ TypeScript éƒ½æœ‰è‰¯å¥½çš„ç±»å‹æ”¯æŒ

**æ™ºèƒ½ä½“æ‰§è¡Œæµç¨‹**:
```typescript
// å‰ç«¯ï¼šå¯åŠ¨æ™ºèƒ½ä½“
const agentId = await invoke<string>('launch_agent', {
  agentType: 'review',
  prompt: 'å®¡æŸ¥è¿™ä¸ªæ–‡ä»¶çš„ä»£ç ',
  context: { filePath: 'src/main.rs' },
  tools: ['read', 'grep'],
});

// ç›‘å¬æ™ºèƒ½ä½“çŠ¶æ€äº‹ä»¶
await listen<AgentStatusEvent>('agent:status', (event) => {
  const { agentId, status, progress, logs } = event.payload;
  updateAgentPanel(agentId, status, progress, logs);
});

// ç›‘å¬æ™ºèƒ½ä½“è¾“å‡ºæµ
await listen<AgentOutputEvent>('agent:output', (event) => {
  const { agentId, chunk } = event.payload;
  appendToChat(agentId, chunk);
});

// ç­‰å¾…æ™ºèƒ½ä½“å®Œæˆ
const result = await invoke<AgentResult>('get_agent_result', { agentId });
```

**åç«¯äº‹ä»¶å‘é€**:
```rust
// æ›´æ–°çŠ¶æ€
app_handle.emit_all("agent:status", AgentStatusEvent {
    agent_id: agent_id.clone(),
    status: AgentStatus::Running,
    progress: 0.5,
    logs: vec!["æ­£åœ¨è¯»å–æ–‡ä»¶...".to_string()],
})?;

// æµå¼è¾“å‡º
app_handle.emit_all("agent:output", AgentOutputEvent {
    agent_id: agent_id.clone(),
    chunk: "å‘ç°ä¸€ä¸ªæ½œåœ¨çš„ç©ºæŒ‡é’ˆé—®é¢˜...".to_string(),
})?;
```

## Architectureï¼ˆæ¶æ„è®¾è®¡ï¼‰

### æ¨¡å—åˆ’åˆ†

#### å‰ç«¯æ¨¡å—

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ PromptManager/          # æç¤ºè¯ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ PromptEditor.tsx    # æç¤ºè¯ç¼–è¾‘å™¨
â”‚   â”‚   â”œâ”€â”€ PromptList.tsx      # æç¤ºè¯åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ TemplateViewer.tsx  # æ¨¡æ¿é¢„è§ˆ
â”‚   â”‚   â””â”€â”€ VersionHistory.tsx  # ç‰ˆæœ¬å†å²
â”‚   â”œâ”€â”€ AgentPanel/             # æ™ºèƒ½ä½“é¢æ¿
â”‚   â”‚   â”œâ”€â”€ AgentList.tsx       # æ™ºèƒ½ä½“åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ AgentStatus.tsx     # çŠ¶æ€æ˜¾ç¤º
â”‚   â”‚   â”œâ”€â”€ AgentLogs.tsx       # æ—¥å¿—è¾“å‡º
â”‚   â”‚   â””â”€â”€ AgentControl.tsx    # æ§åˆ¶æŒ‰é’®
â”‚   â”œâ”€â”€ ToolExplorer/           # å·¥å…·æµè§ˆå™¨
â”‚   â”‚   â”œâ”€â”€ ToolList.tsx        # å·¥å…·åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ ToolDetail.tsx      # å·¥å…·è¯¦æƒ…
â”‚   â”‚   â”œâ”€â”€ ToolTester.tsx      # å·¥å…·æµ‹è¯•
â”‚   â”‚   â””â”€â”€ CallHistory.tsx     # è°ƒç”¨å†å²
â”‚   â””â”€â”€ AIChat/                 # AI å¯¹è¯ï¼ˆæ‰©å±•ï¼‰
â”‚       â”œâ”€â”€ MessageItem.tsx     # æ¶ˆæ¯é¡¹ï¼ˆæ–°å¢æç¤ºè¯ã€å·¥å…·æ˜¾ç¤ºï¼‰
â”‚       â”œâ”€â”€ ThinkingBlock.tsx   # æ€è€ƒè¿‡ç¨‹
â”‚       â””â”€â”€ SessionNotes.tsx    # ä¼šè¯ç¬”è®°
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ promptStore.ts          # æç¤ºè¯çŠ¶æ€
â”‚   â”œâ”€â”€ agentStore.ts           # æ™ºèƒ½ä½“çŠ¶æ€
â”‚   â”œâ”€â”€ toolStore.ts            # å·¥å…·çŠ¶æ€
â”‚   â””â”€â”€ conversationStore.ts    # å¯¹è¯çŠ¶æ€ï¼ˆæ‰©å±•ï¼‰
â””â”€â”€ types/
    â”œâ”€â”€ prompt.ts               # æç¤ºè¯ç±»å‹
    â”œâ”€â”€ agent.ts                # æ™ºèƒ½ä½“ç±»å‹
    â””â”€â”€ tool.ts                 # å·¥å…·ç±»å‹
```

#### åç«¯æ¨¡å—

```
src-tauri/src/
â”œâ”€â”€ prompt_manager/
â”‚   â”œâ”€â”€ mod.rs                  # æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ storage.rs              # æç¤ºè¯å­˜å‚¨ï¼ˆCRUDï¼‰
â”‚   â”œâ”€â”€ template.rs             # æ¨¡æ¿æ¸²æŸ“
â”‚   â”œâ”€â”€ variables.rs            # å˜é‡è§£æ
â”‚   â””â”€â”€ versioning.rs           # ç‰ˆæœ¬ç®¡ç†
â”œâ”€â”€ agent_system/
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ supervisor.rs           # æ™ºèƒ½ä½“ç›‘ç£è€…
â”‚   â”œâ”€â”€ router.rs               # æ¶ˆæ¯è·¯ç”±
â”‚   â”œâ”€â”€ base.rs                 # æ™ºèƒ½ä½“åŸºç±» trait
â”‚   â””â”€â”€ agents/                 # å†…ç½®æ™ºèƒ½ä½“
â”‚       â”œâ”€â”€ explore.rs
â”‚       â”œâ”€â”€ review.rs
â”‚       â”œâ”€â”€ test_gen.rs
â”‚       â”œâ”€â”€ doc_gen.rs
â”‚       â””â”€â”€ refactor.rs
â”œâ”€â”€ tool_registry/
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ registry.rs             # å·¥å…·æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ executor.rs             # å·¥å…·æ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ descriptor.rs           # å·¥å…·æè¿°
â”‚   â”œâ”€â”€ sandbox.rs              # æ²™ç®±å’Œæƒé™
â”‚   â””â”€â”€ tools/                  # å†…ç½®å·¥å…·
â”‚       â”œâ”€â”€ read.rs
â”‚       â”œâ”€â”€ write.rs
â”‚       â”œâ”€â”€ edit.rs
â”‚       â”œâ”€â”€ glob.rs
â”‚       â”œâ”€â”€ grep.rs
â”‚       â”œâ”€â”€ bash.rs
â”‚       â””â”€â”€ lsp.rs
â”œâ”€â”€ conversation/
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ summarizer.rs           # å¯¹è¯æ€»ç»“
â”‚   â”œâ”€â”€ notes.rs                # ä¼šè¯ç¬”è®°
â”‚   â””â”€â”€ storage.rs              # ä¼šè¯å­˜å‚¨
â””â”€â”€ commands/
    â”œâ”€â”€ prompt_commands.rs      # æç¤ºè¯ç›¸å…³å‘½ä»¤
    â”œâ”€â”€ agent_commands.rs       # æ™ºèƒ½ä½“ç›¸å…³å‘½ä»¤
    â”œâ”€â”€ tool_commands.rs        # å·¥å…·ç›¸å…³å‘½ä»¤
    â””â”€â”€ conversation_commands.rs # å¯¹è¯ç›¸å…³å‘½ä»¤
```

### æ•°æ®æµ

#### æ™ºèƒ½ä½“æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·å‘èµ·è¯·æ±‚
    â”‚
    â–¼
[AIChat ç»„ä»¶] è§£æè¯·æ±‚ï¼Œè¯†åˆ«éœ€è¦è°ƒç”¨çš„æ™ºèƒ½ä½“
    â”‚
    â–¼
invoke('launch_agent', { type, prompt, context, tools })
    â”‚
    â–¼
[åç«¯: agent_commands.rs]
    â”‚
    â”œâ”€â”€> åŠ è½½æç¤ºè¯æ¨¡æ¿
    â”‚    (prompt_manager::template::render)
    â”‚
    â”œâ”€â”€> åˆ›å»ºæ™ºèƒ½ä½“å®ä¾‹
    â”‚    (agent_system::supervisor::spawn_agent)
    â”‚
    â”œâ”€â”€> æ³¨å…¥å·¥å…·
    â”‚    (tool_registry::registry::get_tools)
    â”‚
    â””â”€â”€> å¯åŠ¨å¼‚æ­¥ä»»åŠ¡
         (tokio::spawn)
              â”‚
              â–¼
         [Agent æ‰§è¡Œå¾ªç¯]
              â”‚
              â”œâ”€â”€> è°ƒç”¨ ifainew-core ç”Ÿæˆå“åº”
              â”‚    (å‘é€æç¤ºè¯ + å·¥å…·æè¿°)
              â”‚
              â”œâ”€â”€> è§£æ AI å“åº”
              â”‚    (å·¥å…·è°ƒç”¨æˆ–æ–‡æœ¬è¾“å‡º)
              â”‚
              â”œâ”€â”€> å¦‚æœæ˜¯å·¥å…·è°ƒç”¨:
              â”‚    â””â”€â”€> æ‰§è¡Œå·¥å…·
              â”‚         (tool_registry::executor::execute)
              â”‚         â””â”€â”€> å°†ç»“æœè¿”å›ç»™ AI
              â”‚              (ç»§ç»­å¾ªç¯)
              â”‚
              â””â”€â”€> å¦‚æœæ˜¯æ–‡æœ¬è¾“å‡º:
                   â””â”€â”€> å‘é€ç»“æœäº‹ä»¶
                        emit('agent:output', { chunk })
                             â”‚
                             â–¼
                        [å‰ç«¯: listen]
                             â”‚
                             â””â”€â”€> æ›´æ–° UI
                                  (AgentPanel, AIChat)
```

#### æç¤ºè¯æ¸²æŸ“æµç¨‹

```
æ™ºèƒ½ä½“å¯åŠ¨/ç”¨æˆ·ç¼–è¾‘
    â”‚
    â–¼
[prompt_manager::template::render]
    â”‚
    â”œâ”€â”€> è¯»å–æç¤ºè¯æ–‡ä»¶
    â”‚    (storage::read_prompt)
    â”‚
    â”œâ”€â”€> è§£æ YAML Front Matter
    â”‚    (æå–å˜é‡å®šä¹‰ã€ç‰ˆæœ¬ç­‰å…ƒæ•°æ®)
    â”‚
    â”œâ”€â”€> æ”¶é›†å˜é‡å€¼
    â”‚    â”œâ”€â”€> ç³»ç»Ÿå˜é‡ (CWD, USER_NAME)
    â”‚    â”œâ”€â”€> ç”¨æˆ·é…ç½® (.ifai/config.toml)
    â”‚    â””â”€â”€> è¿è¡Œæ—¶ä¼ å…¥ (context å‚æ•°)
    â”‚
    â”œâ”€â”€> Handlebars æ¸²æŸ“
    â”‚    (handlebars::render)
    â”‚
    â””â”€â”€> è¿”å›æœ€ç»ˆæç¤ºè¯æ–‡æœ¬
         â”‚
         â–¼
    å‘é€ç»™ AI æ¨¡å‹
```

### å…³é”®æ¥å£

#### Tauri Commands

```rust
// æç¤ºè¯ç®¡ç†
#[tauri::command]
async fn list_prompts(prompt_type: String) -> Result<Vec<PromptMetadata>, String>;

#[tauri::command]
async fn get_prompt(name: String) -> Result<PromptData, String>;

#[tauri::command]
async fn update_prompt(name: String, content: String, metadata: PromptMetadata) -> Result<(), String>;

#[tauri::command]
async fn render_prompt_template(name: String, variables: HashMap<String, String>) -> Result<String, String>;

// æ™ºèƒ½ä½“ç®¡ç†
#[tauri::command]
async fn launch_agent(
    agent_type: String,
    prompt: String,
    context: AgentContext,
    tools: Vec<String>,
) -> Result<String, String>; // è¿”å› agent_id

#[tauri::command]
async fn get_agent_status(agent_id: String) -> Result<AgentStatus, String>;

#[tauri::command]
async fn stop_agent(agent_id: String) -> Result<(), String>;

#[tauri::command]
async fn get_agent_result(agent_id: String) -> Result<AgentResult, String>;

// å·¥å…·ç®¡ç†
#[tauri::command]
async fn list_tools() -> Result<Vec<ToolDescriptor>, String>;

#[tauri::command]
async fn execute_tool(call: ToolCall) -> Result<ToolResult, String>;

#[tauri::command]
async fn get_tool_call_history(limit: usize) -> Result<Vec<ToolCallRecord>, String>;

// å¯¹è¯ç®¡ç†
#[tauri::command]
async fn summarize_conversation(session_id: String) -> Result<ConversationSummary, String>;

#[tauri::command]
async fn get_session_notes(session_id: String) -> Result<SessionNotes, String>;

#[tauri::command]
async fn update_session_notes(session_id: String, notes: SessionNotes) -> Result<(), String>;
```

## Risks / Trade-offsï¼ˆé£é™©ä¸æƒè¡¡ï¼‰

### é£é™© 1: ç³»ç»Ÿå¤æ‚åº¦å¢åŠ 

**æè¿°**: å¼•å…¥å¤šæ™ºèƒ½ä½“ã€å·¥å…·ç³»ç»Ÿã€æç¤ºè¯ç®¡ç†åï¼Œç³»ç»Ÿå¤æ‚åº¦æ˜¾è‘—å¢åŠ 

**å½±å“**:
- å¼€å‘å’Œç»´æŠ¤æˆæœ¬ä¸Šå‡
- æ–°æ‰‹å­¦ä¹ æ›²çº¿é™¡å³­
- Bug æ’æŸ¥éš¾åº¦å¢åŠ 

**ç¼“è§£æªæ–½**:
1. **åˆ†é˜¶æ®µå®æ–½**: å…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½ï¼ˆ1-2 ä¸ªæ™ºèƒ½ä½“ï¼‰ï¼Œå†é€æ­¥æ‰©å±•
2. **è¯¦ç»†æ–‡æ¡£**: æä¾›æ¶æ„æ–‡æ¡£ã€API æ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œã€è§†é¢‘æ•™ç¨‹
3. **é»˜è®¤é…ç½®**: æä¾›å¼€ç®±å³ç”¨çš„é»˜è®¤é…ç½®ï¼Œé«˜çº§åŠŸèƒ½éšè—åœ¨è®¾ç½®ä¸­
4. **è°ƒè¯•å·¥å…·**: å®ç°æ™ºèƒ½ä½“çŠ¶æ€æŸ¥çœ‹å™¨ã€å·¥å…·è°ƒç”¨æ—¥å¿—ã€æç¤ºè¯è°ƒè¯•å™¨
5. **å•å…ƒæµ‹è¯•**: æ¯ä¸ªæ¨¡å—éƒ½æœ‰å®Œå–„çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

### é£é™© 2: æ€§èƒ½é—®é¢˜

**æè¿°**: å¤šæ™ºèƒ½ä½“å¹¶è¡Œæ‰§è¡Œã€é¢‘ç¹çš„å·¥å…·è°ƒç”¨å¯èƒ½æ¶ˆè€—å¤§é‡èµ„æº

**å½±å“**:
- CPU å’Œå†…å­˜å ç”¨å¢åŠ 
- UI å¡é¡¿
- AI API è°ƒç”¨æˆæœ¬ä¸Šå‡

**ç¼“è§£æªæ–½**:
1. **èµ„æºé™åˆ¶**:
   - æœ€å¤§å¹¶å‘æ™ºèƒ½ä½“æ•°é‡é™åˆ¶ï¼ˆé»˜è®¤ 3 ä¸ªï¼‰
   - æ™ºèƒ½ä½“è¶…æ—¶æœºåˆ¶ï¼ˆ30s æ— å“åº”è‡ªåŠ¨åœæ­¢ï¼‰
   - å·¥å…·æ‰§è¡Œæ—¶é—´é™åˆ¶ï¼ˆ10s è¶…æ—¶ï¼‰
2. **æ™ºèƒ½ç¼“å­˜**:
   - å·¥å…·è°ƒç”¨ç»“æœç¼“å­˜ï¼ˆå¦‚æ–‡ä»¶å†…å®¹ã€æœç´¢ç»“æœï¼‰
   - æç¤ºè¯æ¸²æŸ“ç»“æœç¼“å­˜
   - AI å“åº”ç¼“å­˜ï¼ˆç›¸åŒè¾“å…¥å¤ç”¨ç»“æœï¼‰
3. **æ‡’åŠ è½½**:
   - æ™ºèƒ½ä½“æŒ‰éœ€å¯åŠ¨ï¼Œä¸ç”¨æ—¶è‡ªåŠ¨é‡Šæ”¾
   - å·¥å…·æŒ‰éœ€æ³¨å†Œ
4. **æ€§èƒ½ç›‘æ§**:
   - å®æ—¶ç›‘æ§ CPUã€å†…å­˜ã€ç½‘ç»œä½¿ç”¨
   - æ€§èƒ½è­¦å‘Šå’Œå»ºè®®

### é£é™© 3: å‘åå…¼å®¹é—®é¢˜

**æè¿°**: æ–°çš„å¯¹è¯å­˜å‚¨æ ¼å¼ä¸æ—§ç‰ˆæœ¬ä¸å…¼å®¹

**å½±å“**:
- ç”¨æˆ·å‡çº§åæ—§å¯¹è¯æ— æ³•æ­£å¸¸æ˜¾ç¤º
- æ•°æ®ä¸¢å¤±é£é™©

**ç¼“è§£æªæ–½**:
1. **è‡ªåŠ¨è¿ç§»è„šæœ¬**:
   ```rust
   async fn migrate_conversations(old_version: &str, new_version: &str) -> Result<(), String> {
       // è¯»å–æ—§æ ¼å¼å¯¹è¯
       let old_conversations = read_old_format()?;

       // è½¬æ¢ä¸ºæ–°æ ¼å¼
       let new_conversations = old_conversations.into_iter()
           .map(|c| convert_to_new_format(c))
           .collect();

       // å¤‡ä»½æ—§æ•°æ®
       backup_old_data(&old_conversations)?;

       // å†™å…¥æ–°æ ¼å¼
       write_new_format(&new_conversations)?;

       Ok(())
   }
   ```
2. **ç‰ˆæœ¬æ£€æµ‹**: å¯åŠ¨æ—¶æ£€æµ‹æ•°æ®ç‰ˆæœ¬ï¼Œè‡ªåŠ¨è§¦å‘è¿ç§»
3. **å¤‡ä»½æœºåˆ¶**: è¿ç§»å‰è‡ªåŠ¨å¤‡ä»½ï¼Œå¤±è´¥å¯å›æ»š
4. **å…¼å®¹æ¨¡å¼**: æ”¯æŒè¯»å–æ—§æ ¼å¼ï¼ˆåªè¯»ï¼‰ï¼Œé€æ­¥è¿ç§»

### é£é™© 4: AI API æˆæœ¬

**æè¿°**: æ›´å¤šæ™ºèƒ½ä½“è°ƒç”¨ã€å·¥å…·è°ƒç”¨å¢åŠ  token æ¶ˆè€—

**å½±å“**:
- ç”¨æˆ· API æˆæœ¬ä¸Šå‡
- å¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒ

**ç¼“è§£æªæ–½**:
1. **æœ¬åœ° LLM æ”¯æŒ**:
   - æ”¯æŒ Ollamaã€LM Studio ç­‰æœ¬åœ°æ¨¡å‹
   - ç®€å•ä»»åŠ¡ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹
2. **æ™ºèƒ½è·¯ç”±**:
   - æ ¹æ®ä»»åŠ¡å¤æ‚åº¦é€‰æ‹©æ¨¡å‹ï¼ˆç®€å•ä»»åŠ¡ç”¨ GPT-3.5ï¼Œå¤æ‚ä»»åŠ¡ç”¨ GPT-4ï¼‰
3. **ç”¨æˆ·é¢„ç®—æ§åˆ¶**:
   - è®¾ç½®æ¯æœˆ token é¢„ç®—
   - æ¥è¿‘é¢„ç®—æ—¶è­¦å‘Š
   - è¶…å‡ºé¢„ç®—æ—¶é™åˆ¶è°ƒç”¨
4. **ä¼˜åŒ–æç¤ºè¯**:
   - å‡å°‘å†—ä½™æè¿°
   - ä½¿ç”¨æ›´ç²¾ç®€çš„ç¤ºä¾‹

## Migration Planï¼ˆè¿ç§»è®¡åˆ’ï¼‰

### é˜¶æ®µ 1: æ•°æ®è¿ç§»ï¼ˆè‡ªåŠ¨ï¼‰

**æ—¶æœº**: ç”¨æˆ·é¦–æ¬¡å¯åŠ¨ v0.2.0

**æ­¥éª¤**:
1. æ£€æµ‹æ•°æ®ç‰ˆæœ¬ï¼ˆè¯»å– `.ifai/version.txt`ï¼‰
2. å¦‚æœæ˜¯æ—§ç‰ˆæœ¬ï¼ˆ< 0.2.0ï¼‰ï¼Œå¯åŠ¨è¿ç§»æµç¨‹ï¼š
   ```
   [è¿ç§»è¿›åº¦å¯¹è¯æ¡†]
   æ­£åœ¨å‡çº§æ•°æ®æ ¼å¼...
   â”œâ”€â”€ [âœ“] å¤‡ä»½æ—§æ•°æ®
   â”œâ”€â”€ [âœ“] è¿ç§»å¯¹è¯è®°å½• (15/15)
   â”œâ”€â”€ [â‹¯] è¿ç§»ç”¨æˆ·é…ç½®
   â””â”€â”€ [ ] å®Œæˆ
   ```
3. è¿ç§»å†…å®¹ï¼š
   - å¯¹è¯è®°å½•ï¼š`messages[]` â†’ ç»“æ„åŒ–æ ¼å¼ï¼ˆé™„åŠ æç¤ºè¯ã€å·¥å…·è°ƒç”¨å­—æ®µï¼‰
   - ç”¨æˆ·é…ç½®ï¼šæ·»åŠ æ–°å­—æ®µï¼ˆé»˜è®¤å€¼ï¼‰
   - åˆ›å»ºæ–°ç›®å½•ï¼š`.ifai/prompts/`, `.ifai/agents/`, `.ifai/tools/`
4. å†™å…¥æ–°ç‰ˆæœ¬å·ï¼š`.ifai/version.txt` â†’ `0.2.0`
5. è¿ç§»å®Œæˆåæç¤ºç”¨æˆ·

**å›æ»šæ–¹æ¡ˆ**:
- è¿ç§»å‰å¤‡ä»½åˆ° `.ifai/backup-[timestamp]/`
- å¦‚æœè¿ç§»å¤±è´¥ï¼Œä»å¤‡ä»½æ¢å¤å¹¶æç¤ºç”¨æˆ·
- æä¾›æ‰‹åŠ¨å›æ»šæŒ‰é’®ï¼ˆè®¾ç½® â†’ é«˜çº§ â†’ æ¢å¤å¤‡ä»½ï¼‰

### é˜¶æ®µ 2: æç¤ºè¯åˆå§‹åŒ–ï¼ˆè‡ªåŠ¨ï¼‰

**æ—¶æœº**: é¦–æ¬¡å¯åŠ¨æˆ–ç”¨æˆ·ç‚¹å‡»"å¯¼å…¥é»˜è®¤æ¨¡æ¿"

**æ­¥éª¤**:
1. ä»å†…ç½®èµ„æºåŒ…è§£å‹é»˜è®¤æç¤ºè¯åˆ° `.ifai/prompts/default/`
2. åŒ…å«çš„æç¤ºè¯ï¼š
   - `system/main.md` - ä¸»ç³»ç»Ÿæç¤ºè¯
   - `agents/explore.md` - Explore æ™ºèƒ½ä½“
   - `agents/review.md` - Review æ™ºèƒ½ä½“
   - `agents/test.md` - Test æ™ºèƒ½ä½“
   - `agents/doc.md` - Doc æ™ºèƒ½ä½“
   - `tools/read.md`, `tools/write.md` ç­‰å·¥å…·æè¿°
3. åœ¨ UI ä¸­æ˜¾ç¤ºï¼š"âœ“ å·²å¯¼å…¥ 15 ä¸ªé»˜è®¤æç¤ºè¯æ¨¡æ¿"

### é˜¶æ®µ 3: ç”¨æˆ·åŸ¹è®­ï¼ˆæ‰‹åŠ¨ï¼‰

**æ—¶æœº**: ç”¨æˆ·é¦–æ¬¡å‡çº§åˆ° v0.2.0

**å†…å®¹**:
1. æ˜¾ç¤º"æ–°åŠŸèƒ½å¼•å¯¼"å¯¹è¯æ¡†ï¼ˆå¯è·³è¿‡ï¼‰ï¼š
   ```
   ğŸ‰ æ¬¢è¿ä½¿ç”¨è‹¥çˆ± v0.2.0ï¼

   æ–°åŠŸèƒ½ä»‹ç»ï¼š
   âœ¨ æç¤ºè¯ç®¡ç† - è‡ªå®šä¹‰ AI è¡Œä¸º
   ğŸ¤– ä¸“ä¸šæ™ºèƒ½ä½“ - ä»£ç å®¡æŸ¥ã€æµ‹è¯•ç”Ÿæˆç­‰
   ğŸ”§ å·¥å…·ç³»ç»Ÿ - æ‰©å±• AI èƒ½åŠ›

   [è§‚çœ‹è§†é¢‘æ•™ç¨‹] [ç¨åæé†’] [ä¸å†æ˜¾ç¤º]
   ```
2. äº¤äº’å¼æ•™ç¨‹ï¼ˆå¯é€‰ï¼‰ï¼š
   - æ­¥éª¤ 1: æ‰“å¼€æç¤ºè¯ç®¡ç†å™¨
   - æ­¥éª¤ 2: ç¼–è¾‘ä¸€ä¸ªæç¤ºè¯
   - æ­¥éª¤ 3: å¯åŠ¨ä¸€ä¸ªæ™ºèƒ½ä½“
   - æ­¥éª¤ 4: æŸ¥çœ‹å·¥å…·è°ƒç”¨å†å²

## Open Questionsï¼ˆå¾…è§£å†³é—®é¢˜ï¼‰

### é—®é¢˜ 1: æ™ºèƒ½ä½“å®šä»·ç­–ç•¥

**é—®é¢˜**: ä½¿ç”¨æ™ºèƒ½ä½“æ˜¯å¦ä¼šæ¶ˆè€—æ›´å¤š tokenï¼Ÿå¦‚ä½•å‘ç”¨æˆ·å±•ç¤ºæˆæœ¬ï¼Ÿ

**é€‰é¡¹**:
- A. æ˜¾ç¤ºæ¯ä¸ªæ™ºèƒ½ä½“çš„ token æ¶ˆè€—ï¼ˆå®æ—¶æ›´æ–°ï¼‰
- B. åœ¨å¯¹è¯ç»“æŸåæ±‡æ€»å±•ç¤º
- C. ä¸æ˜¾ç¤ºï¼Œç”¨æˆ·è‡ªè¡Œåœ¨ AI æœåŠ¡å•†æŸ¥çœ‹

**å€¾å‘**: Aï¼Œæä¾›é€æ˜åº¦

**å¾…å®šäº‹é¡¹**: éœ€è¦ä¸ ifainew-core å›¢é˜Ÿç¡®è®¤ token è®¡æ•° API

### é—®é¢˜ 2: è‡ªå®šä¹‰å·¥å…·çš„å®‰å…¨æ€§

**é—®é¢˜**: ç”¨æˆ·è‡ªå®šä¹‰å·¥å…·ï¼ˆWasm æ’ä»¶ï¼‰æ˜¯å¦ä¼šå¸¦æ¥å®‰å…¨é£é™©ï¼Ÿ

**é€‰é¡¹**:
- A. å®Œå…¨ç¦æ­¢ç”¨æˆ·è‡ªå®šä¹‰å·¥å…·
- B. æ²™ç®±æ‰§è¡Œï¼ˆWasm éš”ç¦»ï¼‰
- C. ä»…å…è®¸å®¡æ ¸é€šè¿‡çš„å·¥å…·

**å€¾å‘**: Bï¼Œé€šè¿‡ Wasm æ²™ç®±å’Œæƒé™ç³»ç»Ÿé™åˆ¶

**å¾…å®šäº‹é¡¹**: éœ€è¦è°ƒç ” Rust Wasm è¿è¡Œæ—¶çš„å®‰å…¨æ€§å’Œæ€§èƒ½

### é—®é¢˜ 3: æ™ºèƒ½ä½“é—´åä½œæœºåˆ¶

**é—®é¢˜**: å¤šä¸ªæ™ºèƒ½ä½“å¦‚ä½•åä½œï¼Ÿä¾‹å¦‚ Review Agent å‘ç°é—®é¢˜åï¼Œæ˜¯å¦è‡ªåŠ¨è°ƒç”¨ Refactor Agent ä¿®å¤ï¼Ÿ

**é€‰é¡¹**:
- A. æ™ºèƒ½ä½“å®Œå…¨ç‹¬ç«‹ï¼Œç”¨æˆ·æ‰‹åŠ¨è°ƒç”¨
- B. æ™ºèƒ½ä½“å¯ä»¥è¯·æ±‚è°ƒç”¨å…¶ä»–æ™ºèƒ½ä½“ï¼ˆéœ€ç”¨æˆ·ç¡®è®¤ï¼‰
- C. æ™ºèƒ½ä½“å¯ä»¥è‡ªåŠ¨è°ƒç”¨å…¶ä»–æ™ºèƒ½ä½“ï¼ˆDAG å·¥ä½œæµï¼‰

**å€¾å‘**: Bï¼Œä¿æŒç”¨æˆ·æ§åˆ¶æƒ

**å¾…å®šäº‹é¡¹**: éœ€è¦è®¾è®¡æ™ºèƒ½ä½“é—´æ¶ˆæ¯åè®®å’Œç”¨æˆ·ç¡®è®¤ UI

### é—®é¢˜ 4: æç¤ºè¯ç‰ˆæœ¬å†²çª

**é—®é¢˜**: ç”¨æˆ·è‡ªå®šä¹‰çš„æç¤ºè¯ä¸ç³»ç»Ÿæ›´æ–°çš„é»˜è®¤æç¤ºè¯å†²çªæ—¶å¦‚ä½•å¤„ç†ï¼Ÿ

**é€‰é¡¹**:
- A. ç³»ç»Ÿæ›´æ–°è¦†ç›–ç”¨æˆ·è‡ªå®šä¹‰ï¼ˆå¤‡ä»½æ—§ç‰ˆæœ¬ï¼‰
- B. æç¤ºç”¨æˆ·æ‰‹åŠ¨åˆå¹¶
- C. ä¿ç•™ç”¨æˆ·ç‰ˆæœ¬ï¼Œå¿½ç•¥ç³»ç»Ÿæ›´æ–°

**å€¾å‘**: Bï¼Œæä¾›ä¸‰æ–¹åˆå¹¶ UIï¼ˆç±»ä¼¼ Git mergeï¼‰

**å¾…å®šäº‹é¡¹**: éœ€è¦å®ç°æç¤ºè¯ diff å’Œåˆå¹¶å·¥å…·
