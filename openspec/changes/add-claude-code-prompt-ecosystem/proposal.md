# 提案：引入 Claude Code 提示词生态系统

## Why（为什么）

若爱（IfAI）作为一个 AI 代码编辑器，目前的 AI 功能虽然基本可用，但存在以下核心问题：

1. **AI 行为不透明**：用户无法看到和理解 AI 的系统提示词，导致难以理解 AI 的行为逻辑
2. **单一智能体限制**：只有一个主 AI 智能体，无法针对不同任务（代码审查、测试生成、重构建议等）使用专业化智能体
3. **工具系统缺乏标准化**：AI 可用的工具（文件读写、执行命令等）没有标准化的描述和接口，难以扩展
4. **对话上下文管理不足**：长对话会导致上下文丢失，缺乏自动总结和会话管理机制
5. **用户定制能力弱**：用户无法自定义系统提示词、创建专业智能体或添加自定义工具

**机遇**：[claude-code-system-prompts](https://github.com/Piebald-AI/claude-code-system-prompts) 项目提供了一个成熟的、经过实战验证的系统提示词生态架构，包含：
- 40+ 模块化系统提示词
- 多智能体架构（Explore、Plan、Task 等）
- 标准化工具描述系统
- 对话总结和管理机制
- 版本化和可追踪性

将这套生态深度融合到 IfAI 中，可以大幅提升 AI 功能的专业性、透明度和可扩展性。

## What Changes（变更内容）

### 核心功能模块

#### 1. 系统提示词管理器 (Prompt Manager)

**核心设计：分层公开策略**

基于透明度和商业保护的平衡，采用三层提示词管理架构：

- **🟢 公开层（80% - 完全开放）**：
  - 用户自定义提示词（`.ifai/prompts/custom/`）
  - 官方智能体模板（Explore、Review、Test、Doc、Refactor）
  - 工具描述提示词（Read、Write、Grep 等）
  - 示例提示词库
  - 用户权限：✅ 查看、✅ 编辑、✅ 导出、✅ 版本控制

- **🟡 半透明层（15% - 可见不可编辑）**：
  - 系统主提示词（定义 AI 基本行为）
  - 安全和权限规则
  - 对话管理提示词（总结、笔记生成）
  - 用户权限：✅ 查看完整内容、✅ 复制、❌ 直接编辑、⚠️ 专家模式可覆盖

- **🔴 隐藏层（5% - 完全私有）**：
  - ifainew-core 内部提示词（商业机密）
  - 专有算法和优化技巧
  - 反滥用规则（防止提示词注入）
  - 用户权限：❌ 完全不可见

**功能特性**：
- 在 IfAI 中实现提示词编辑、预览、版本控制 UI
- 支持导入 claude-code-system-prompts 的提示词模板库
- 提供提示词变量替换和模板系统（Handlebars）
- 分层访问控制和权限管理
- 提示词 diff 和版本对比功能
- 专家模式：高级用户可覆盖系统提示词

#### 2. 多智能体系统 (Multi-Agent System)
- 引入 `Task` 工具概念，支持启动专业子智能体
- 实现核心专业智能体：
  - **Explore Agent**: 只读代码探索，快速搜索和分析代码
  - **Review Agent**: 代码审查，发现潜在问题和改进点
  - **Test Agent**: 自动生成单元测试和集成测试
  - **Doc Agent**: 生成和更新代码文档
  - **Refactor Agent**: 提供重构建议和自动重构
  - **Security Agent**: 安全审查，发现漏洞和安全问题
- 支持智能体并行执行和任务分发
- 智能体间通信和协作机制
- 智能体执行状态可视化（进度、日志、结果）

#### 3. 工具描述系统 (Tool Description System)
- 标准化工具接口定义（类似 claude-code 的工具描述格式）
- 核心工具集：
  - `Read`: 读取文件
  - `Write`: 写入文件
  - `Edit`: 编辑文件（精确字符串替换）
  - `Glob`: 文件模式匹配搜索
  - `Grep`: 文件内容正则搜索
  - `Bash`: 执行 Shell 命令
  - `LSP`: Language Server Protocol 集成
- 工具描述 Markdown 格式（包含描述、参数、示例、注意事项）
- 工具发现和动态加载机制
- 支持用户创建自定义工具（通过 TypeScript/Rust 插件）

#### 4. 对话管理系统 (Conversation Management)
- 自动对话总结机制（基于 token 阈值或消息数量）
- 总结模板系统（采用 claude-code 的总结提示词）
- 会话笔记功能：
  - 技术概念追踪
  - 文件变更历史
  - 错误和修复记录
  - 待办任务列表
- 会话恢复和继续功能
- 多会话管理和切换

#### 5. AI 行为透明化 (AI Transparency)
- 实时显示当前使用的系统提示词
- 显示智能体的工作流程和执行步骤
- 工具调用历史和参数记录
- 提供"思考过程"可视化（类似 Claude 的 thinking blocks）
- 支持用户查看、调试和优化提示词效果

### 技术架构变更

#### 前端 (React/TypeScript)
- 新增 `PromptManager` 组件：提示词编辑和管理 UI
- 新增 `AgentPanel` 组件：智能体执行状态和日志面板
- 新增 `ToolExplorer` 组件：工具浏览和测试界面
- 扩展 `AIChat` 组件：支持显示系统提示词、工具调用、智能体状态
- 新增 Zustand store: `promptStore`, `agentStore`, `toolStore`

#### 后端 (Rust/Tauri)
- 新增 `prompt_manager` 模块：提示词 CRUD、模板渲染、版本管理
- 新增 `agent_system` 模块：智能体生命周期管理、任务调度、状态追踪
- 新增 `tool_registry` 模块：工具注册、发现、执行、权限控制
- 扩展 `conversation` 模块：总结生成、会话持久化、上下文管理
- 新增 Tauri 命令：
  - `get_prompts`, `update_prompt`, `render_prompt_template`
  - `launch_agent`, `get_agent_status`, `stop_agent`
  - `list_tools`, `execute_tool`, `register_custom_tool`
  - `summarize_conversation`, `get_session_notes`

#### ifainew-core 包集成
- 扩展 AI 模型接口以支持：
  - 动态系统提示词注入
  - 工具调用标准化（OpenAI function calling 格式）
  - 流式响应中的智能体状态事件
- 添加 RAG 增强：根据任务类型自动检索相关提示词和示例

### 数据模型变更

#### 新增配置文件
```
.ifai/
├── prompts/                 # 用户自定义提示词
│   ├── system/             # 系统提示词
│   ├── agents/             # 智能体提示词
│   └── tools/              # 工具描述
├── agents/                  # 智能体定义
│   └── custom/             # 用户自定义智能体
├── tools/                   # 工具定义
│   └── custom/             # 用户自定义工具
└── sessions/                # 会话数据
    ├── notes/              # 会话笔记
    └── summaries/          # 对话总结
```

#### 新增数据结构
- `PromptTemplate`: 提示词模板（变量、版本、元数据）
- `AgentDefinition`: 智能体定义（类型、提示词、可用工具、权限）
- `ToolDescriptor`: 工具描述（名称、参数、示例、约束）
- `ConversationSummary`: 对话总结（技术概念、文件变更、待办任务等）
- `SessionNotes`: 会话笔记（结构化记录）

### UI/UX 变更

#### 新增界面功能
1. **提示词管理界面**
   - 侧边栏新增"提示词"标签页
   - 提示词编辑器（Monaco Editor 支持 Markdown）
   - 变量预览和模板渲染实时预览
   - 版本历史和对比
   - 导入/导出提示词包

2. **智能体面板**
   - 底部面板新增"智能体"标签页
   - 显示运行中的智能体状态
   - 实时日志输出
   - 任务进度条和执行步骤
   - 停止/恢复智能体控制

3. **工具浏览器**
   - 侧边栏新增"工具"标签页
   - 工具列表和分类（文件、搜索、执行等）
   - 工具详情和示例
   - 工具测试界面（手动输入参数并执行）
   - 工具调用历史记录

4. **AI 对话增强**
   - 消息中显示使用的提示词（可折叠）
   - 显示工具调用详情（工具名、参数、结果）
   - 智能体切换指示器
   - "思考过程"展开/折叠
   - 会话总结查看和编辑

5. **会话管理**
   - 对话列表支持会话分组和标签
   - 会话笔记编辑器
   - 一键生成总结
   - 会话导出（Markdown 格式）

### Breaking Changes（破坏性变更）

**BREAKING**: AI 对话存储格式变更
- 旧版本：简单的 `messages[]` 数组
- 新版本：包含提示词、工具调用、智能体状态的结构化格式
- 迁移方案：提供自动迁移脚本，将旧对话转换为新格式

**BREAKING**: ifainew-core 接口变更
- 原 `generate_response(messages)` 改为 `generate_response(messages, prompt_context, tools)`
- 需要更新 ifainew-core 版本至 v0.2.0+

## Impact（影响范围）

### 受影响的规格说明（Affected Specs）
- **ai-chat**: AI 对话功能（新增提示词显示、工具调用、智能体状态）
- **file-management**: 文件管理（新增工具系统集成）
- **新增**: `prompt-management` - 提示词管理
- **新增**: `agent-system` - 智能体系统
- **新增**: `tool-registry` - 工具注册表
- **新增**: `conversation-management` - 对话管理

### 受影响的代码（Affected Code）
- **前端核心文件** (10+ 文件):
  - `src/components/AIChat/index.tsx` - 对话组件
  - `src/stores/chatStore.ts` - 对话状态管理
  - 新增多个组件和 store 文件
- **后端核心文件** (15+ 文件):
  - `src-tauri/src/lib.rs` - 新命令注册
  - `src-tauri/src/ai_chat.rs` - AI 对话逻辑
  - 新增多个模块文件
- **ifainew-core 包**:
  - 需要升级并扩展接口

### 工作量估算
- **提示词管理器**: 2-3 周（UI + 后端 + 测试）
- **多智能体系统**: 3-4 周（架构 + 核心智能体 + 协作机制）
- **工具描述系统**: 2 周（标准化 + 核心工具 + 插件系统）
- **对话管理**: 1-2 周（总结 + 笔记 + 会话管理）
- **透明化功能**: 1 周（UI 集成 + 调试工具）
- **测试和优化**: 2 周
- **文档编写**: 1 周

**总计**: 约 12-15 周（3-4 个月）

### 用户体验提升
1. **可控性**: 用户可以自定义 AI 行为，调整提示词
2. **专业性**: 专业智能体提供更精准的领域帮助
3. **透明度**: 清晰了解 AI 在做什么，为什么这么做
4. **效率**: 智能体并行执行，工具自动化提升效率
5. **可扩展性**: 用户可以创建自定义智能体和工具

### 风险和缓解措施
1. **复杂度风险**: 系统变得复杂，学习曲线陡峭
   - 缓解：提供详细文档和交互式教程，默认配置开箱即用
2. **性能风险**: 多智能体并行可能消耗大量资源
   - 缓解：智能体资源限制、队列管理、用户可配置并发数
3. **兼容性风险**: 与现有 AI 对话数据不兼容
   - 缓解：提供自动迁移工具和向后兼容模式
4. **API 成本风险**: 更多的 AI 调用增加成本
   - 缓解：智能缓存、本地 LLM 支持、用户预算控制

## Success Metrics（成功指标）

1. **功能完整性**:
   - ✓ 至少 5 种核心智能体可用
   - ✓ 至少 10 种核心工具注册
   - ✓ 提示词模板库包含 30+ 模板
   - ✓ 对话总结准确率 > 90%

2. **性能指标**:
   - ✓ 智能体启动时间 < 2 秒
   - ✓ 工具执行响应时间 < 500ms
   - ✓ 提示词渲染时间 < 100ms
   - ✓ 会话总结生成时间 < 10 秒

3. **用户体验**:
   - ✓ 用户满意度调查 > 4.5/5
   - ✓ 提示词自定义使用率 > 30%
   - ✓ 智能体使用频率 > 每天 5 次
   - ✓ 文档完整性和清晰度评分 > 4/5

4. **稳定性**:
   - ✓ 智能体崩溃率 < 1%
   - ✓ 工具执行失败率 < 5%
   - ✓ 迁移成功率 > 99%

## Alignment with Project Vision（与项目愿景的对齐）

若爱（IfAI）的核心愿景是"让 AI 成为开发者最贴心的编程伴侣"。此提案与愿景高度对齐：

1. **"贴心"** = 透明可控：用户可以看到和调整 AI 的"思考方式"
2. **"编程伴侣"** = 专业助手：专业智能体在各个环节（审查、测试、文档）提供帮助
3. **"最"** = 最佳体验：通过工具系统和对话管理提供流畅、高效的交互

同时，此提案符合项目的技术哲学：
- **轻量高效**: 保持 Rust + Tauri 架构的性能优势
- **本地优先**: 提示词、工具、会话数据本地存储和管理
- **开放可扩展**: 支持用户自定义，构建生态

## Next Steps（后续步骤）

1. **评审和反馈** (1 周)
   - 团队评审此提案
   - 收集用户和社区反馈
   - 调整设计细节

2. **技术预研** (1 周)
   - 验证多智能体架构可行性
   - 测试工具系统性能
   - 评估 ifainew-core 改造成本

3. **启动开发** (12-15 周)
   - 按照 tasks.md 中的任务清单逐步实施
   - 每 2 周发布一个 alpha 版本供内部测试
   - 持续收集反馈并迭代

4. **Beta 测试** (2 周)
   - 发布公开 beta 版本
   - 收集用户反馈和 bug 报告
   - 性能调优和稳定性改进

5. **正式发布** (v0.2.0)
   - 完整文档和教程
   - 营销推广
   - 社区支持和生态建设
